# 数据库索引配置

## 问题
云开发数据库查询缺乏高效的索引支持，影响查询性能。

## 索引建议

### daily_records 集合

需要创建以下组合索引以优化查询：

```json
{
  "type": 1,    // 升序
  "date": -1    // 降序
}
```

## 创建方式

### 方法1：通过快速创建链接（推荐）
点击控制台中提供的快速创建索引链接即可自动创建。

### 方法2：手动创建
1. 打开微信开发者工具
2. 点击"云开发"控制台
3. 进入"数据库" > "daily_records" 集合
4. 点击"索引管理"
5. 点击"添加索引"
6. 添加以下字段：
   - 字段名：type，排序方式：升序(1)
   - 字段名：date，排序方式：降序(-1)
7. 保存

## 优化后的效果
- 加快 `where({ type: 'user_settings' }).orderBy('date', 'desc')` 查询速度
- 加快 `where({ type: 'weight_check' }).orderBy('date', 'desc')` 查询速度
- 减少数据库扫描的文档数量
- 降低云函数调用时间和费用

## 注意事项
- 索引会占用一定的存储空间
- 每次写入数据时会更新索引，略微增加写入时间
- 对于频繁查询的场景，索引带来的性能提升远大于开销

---

# 云函数调试指南

## 问题：云函数连接失败

### 常见原因及解决方案

#### 1. 云函数未部署或未上传
**检查步骤：**
- 打开微信开发者工具
- 点击"云开发"控制台
- 进入"云函数" > 查看 `identifyfood` 是否存在
- 查看部署时间是否是最新的

**解决方案：**
```bash
# 右键点击 cloudfunctions/identifyfood 文件夹
# 选择"上传并部署：云端安装依赖"
```

#### 2. 云函数依赖未安装
**检查步骤：**
- 查看云函数列表中 `identifyfood` 的"依赖状态"
- 应该显示 `wx-server-sdk` 已安装

**解决方案：**
```bash
# 进入云函数目录
cd cloudfunctions/identifyfood

# 安装依赖
npm install

# 重新上传并部署（右键 > 上传并部署：云端安装依赖）
```

#### 3. 云环境 ID 不匹配
**检查步骤：**
- 打开 `miniprogram/app.js`，查看 env 值
- 打开 `miniprogram/pages/index/index.js`，查看 env 值
- 打开云开发控制台，查看当前环境 ID
- **确保三者一致**

**当前环境 ID：** `cloud1-0gtnqy3z1c048750`

#### 4. 云函数权限问题
**检查步骤：**
- 云开发控制台 > 设置 > 权限设置
- 确认"所有用户可读，仅创建者可写"或更宽松的权限

#### 5. 开发者工具未登录云开发
**解决方案：**
- 点击开发者工具顶部"云开发"按钮
- 确保已登录并选择正确的云环境

#### 6. 本地调试器未启用云函数调试
**解决方案：**
- 工具栏 > 编译模式 > 选择"普通编译"
- 确保"本地设置"中勾选了"不校验合法域名"

### 调试技巧

#### 查看详细错误信息
已在代码中添加详细日志输出：
```javascript
console.log('云函数返回结果：', resCloud);
console.error('云函数调用失败：', err);
```

**查看日志：**
1. 开发者工具 > 控制台 > Console 标签
2. 云开发控制台 > 云函数 > identifyfood > 日志

#### 测试云函数
在云开发控制台测试：
1. 进入"云函数" > `identifyfood`
2. 点击"测试"按钮
3. 输入测试数据：
```json
{
  "fileID": "cloud://cloud1-0gtnqy3z1c048750.xxxx"
}
```
4. 点击"运行测试"查看结果

### 快速排查流程

1. ✅ 检查控制台是否有详细错误信息
2. ✅ 确认云函数已部署（右键文件夹 > 上传并部署）
3. ✅ 确认环境 ID 一致
4. ✅ 在云开发控制台测试云函数
5. ✅ 查看云函数日志

### 临时解决方案
如果云函数暂时无法使用，代码已添加手动输入功能作为备选方案。
